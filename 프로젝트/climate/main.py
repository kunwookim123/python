import pandas as pd
import folium
import os
from sklearn.linear_model import LinearRegression

# ===== íŒŒì¼ ê²½ë¡œ =====
sun_path = r"C:\Users\UserK\Documents\ì¼ì¡°_ì¼ì‚¬_í†µí•©í‰ê· _2020_2024.csv"
rain_path = r"C:\Users\UserK\Documents\ê°•ìˆ˜ëŸ‰_í†µí•©í‰ê· _2020_2024.csv"
output_path = r"C:\Users\UserK\Documents\ê¸°ìƒë°ì´í„°_ì „êµ­ì§€ë„.html"

# ===== ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° =====
sun_df = pd.read_csv(sun_path)
rain_df = pd.read_csv(rain_path)

sun_df.rename(columns={"í†µí•©ì§€ì—­": "ì§€ì—­"}, inplace=True)
rain_df.rename(columns={"í†µí•©ì§€ì—­": "ì§€ì—­"}, inplace=True)

# ===== ë³‘í•© =====
merged = pd.merge(sun_df, rain_df, on="ì§€ì—­", how="outer")

# ===== ë¶ë¶€ ì§€ì—­ ë³‘í•© =====
replace_dict = {
    "ë¶ê°•ë¦‰": "ê°•ë¦‰",
    "ë¶ë¶€ì‚°": "ë¶€ì‚°",
    "ë¶ì°½ì›": "ì°½ì›",
    "ë¶ì¶˜ì²œ": "ì¶˜ì²œ",
    "ì„œì²­ì£¼": "ì²­ì£¼"
}
merged["ì§€ì—­"] = merged["ì§€ì—­"].replace(replace_dict)

# ===== í‰ê·  ì¬ê³„ì‚° =====
merged = merged.groupby("ì§€ì—­", as_index=False).mean(numeric_only=True)

# ===== âœ… ì¼ì‚¬ëŸ‰ ê²°ì¸¡ê°’ ë° 0ê°’ ì¶”ì • (ê°œì„  ë²„ì „) =====
solar_col = "í•©ê³„ ì¼ì‚¬ëŸ‰(MJ/m2)"
sun_col = "í•©ê³„ ì¼ì¡°ì‹œê°„(hr)"

# 0 ë˜ëŠ” ë¹„ì •ìƒì ìœ¼ë¡œ ë‚®ì€ ê°’(ì˜ˆ: 50 ë¯¸ë§Œ)ë„ ê²°ì¸¡ ì²˜ë¦¬
merged.loc[(merged[solar_col].isna()) | (merged[solar_col] < 50), solar_col] = None

if merged[solar_col].isna().sum() > 0:
    df_train = merged.dropna(subset=[sun_col, solar_col])
    if len(df_train) > 2:
        from sklearn.linear_model import LinearRegression
        X = df_train[[sun_col]]
        y = df_train[solar_col]
        model = LinearRegression()
        model.fit(X, y)

        missing_mask = merged[solar_col].isna() & merged[sun_col].notna()
        merged.loc[missing_mask, solar_col] = model.predict(
            merged.loc[missing_mask, [sun_col]]
        )

        print(f"âœ… ì¼ì‚¬ëŸ‰ NaN/0/ë¹„ì •ìƒì¹˜ ë³´ì • ì™„ë£Œ ({missing_mask.sum()}ê°œ ì§€ì—­ ì¶”ì •)")
    else:
        print("âš ï¸ ì¼ì‚¬ëŸ‰ íšŒê·€ ì¶”ì •ìš© ë°ì´í„° ë¶€ì¡±, ë³´ì • ê±´ë„ˆëœ€")
else:
    print("âœ… ì¼ì‚¬ëŸ‰ ê²°ì¸¡ê°’ ë° ë¹„ì •ìƒê°’ ì—†ìŒ")

# ===== ì „êµ­ ì£¼ìš” ê´€ì¸¡ì†Œ ì¢Œí‘œ (ê¸°ìƒì²­ 93ê°œ ê¸°ì¤€) =====
coords = {
    "ì„œìš¸": [37.5714, 126.9658], "ì¸ì²œ": [37.4772, 126.6249], "ìˆ˜ì›": [37.2578, 127.0109],
    "ê°•ë¦‰": [37.7519, 128.8761], "ì¶˜ì²œ": [37.9027, 127.7354], "ì²­ì£¼": [36.6424, 127.4890],
    "ëŒ€ì „": [36.3504, 127.3845], "ì „ì£¼": [35.8204, 127.1086], "ê´‘ì£¼": [35.1631, 126.8516],
    "ëª©í¬": [34.8161, 126.3810], "ì—¬ìˆ˜": [34.7399, 127.7403], "ìˆœì²œ": [34.9523, 127.4875],
    "ëŒ€êµ¬": [35.8714, 128.6014], "ë¶€ì‚°": [35.1796, 129.0756], "ìš¸ì‚°": [35.5384, 129.3114],
    "í¬í•­": [36.0190, 129.3435], "ì°½ì›": [35.2270, 128.6811], "ì§„ì£¼": [35.1802, 128.1076],
    "í†µì˜": [34.8544, 128.4330], "ê±°ì œ": [34.8806, 128.6217], "ì„œê·€í¬": [33.2530, 126.5600],
    "ì œì£¼": [33.4996, 126.5312], "ì„œì‚°": [36.7796, 126.4916], "ì„¸ì¢…": [36.4801, 127.2892],
    "í™ì„±": [36.6012, 126.6608], "ì²œì•ˆ": [36.8152, 127.1139], "ì¶©ì£¼": [36.9911, 127.9250],
    "ì˜ì›”": [37.1803, 128.4640], "ì›ì£¼": [37.3417, 127.9208], "ìš¸ì§„": [36.9931, 129.4005],
    "ì•ˆë™": [36.5683, 128.7294], "ìƒì£¼": [36.4069, 128.1570], "ì˜ì„±": [36.3538, 128.6975],
    "ì˜ì²œ": [35.9733, 128.9402], "êµ¬ë¯¸": [36.1195, 128.3445], "ê²½ì£¼": [35.8562, 129.2247],
    "ê¹€í•´": [35.2298, 128.8908], "ì–‘ì‚°": [35.3337, 129.0373], "ê±°ì°½": [35.6867, 127.9093],
    "í•©ì²œ": [35.5669, 128.1650], "ì‚°ì²­": [35.4158, 127.8794], "í•¨ì–‘": [35.5200, 127.7254],
    "ì˜ë ¹": [35.3225, 128.2617], "ë³´ì„±": [34.7617, 127.0805], "ê°•ì§„": [34.6422, 126.7695],
    "ì¥í¥": [34.6810, 126.9019], "í•´ë‚¨": [34.5744, 126.5983], "ê³ í¥": [34.6091, 127.2826],
    "ì§„ë„": [34.4848, 126.2636], "ì˜ê´‘": [35.2763, 126.5113], "ê³ ì°½": [35.4350, 126.7019],
    "ë¶€ì•ˆ": [35.7276, 126.7160], "ì„ì‹¤": [35.6131, 127.2895], "ì •ì": [35.5700, 126.8554],
    "ë‚¨ì›": [35.4161, 127.3905], "ìˆœì°½": [35.3747, 127.1361], "ì¥ìˆ˜": [35.6479, 127.5214],
    "êµ°ì‚°": [35.9676, 126.7368], "ì„œì²­ì£¼": [36.6435, 127.4786], "ë³´ì€": [36.4890, 127.7134],
    "ê¸ˆì‚°": [36.1046, 127.4794], "ë¶€ì—¬": [36.2752, 126.9127], "ë…¼ì‚°": [36.1871, 127.0986],
    "ë³´ë ¹": [36.3275, 126.5570], "ì˜ˆì‚°": [36.6826, 126.8482], "í™ì²œ": [37.6882, 127.8804],
    "ì¸ì œ": [38.0610, 128.1706], "ì² ì›": [38.1462, 127.3135], "ë™ë‘ì²œ": [37.9019, 127.0603],
    "íŒŒì£¼": [37.7570, 126.7750], "ì–‘í‰": [37.4916, 127.4872], "ì´ì²œ": [37.2721, 127.4350],
    "ì œì²œ": [37.1326, 128.1916], "íƒœë°±": [37.1641, 128.9854], "ì •ì„ ": [37.3801, 128.6635],
    "ì†ì´ˆ": [38.2070, 128.5912], "ëŒ€ê´€ë ¹": [37.6885, 128.7577], "ë¶ì¶˜ì²œ": [37.9230, 127.7325],
    "ìš¸ë¦‰ë„": [37.4843, 130.9055], "í™ì²œ": [37.6882, 127.8804], "ë´‰í™”": [36.9432, 128.9115],
    "ë¬¸ê²½": [36.5861, 128.1892], "ì˜ì£¼": [36.8052, 128.6245], "ì²­ì†¡": [36.4352, 129.0573],
    "ì˜ë•": [36.4154, 129.3753], "ê³ ì‚°": [33.2930, 126.1628], "ì„±ì‚°": [33.3858, 126.8796],
    "ë‚¨í•´": [34.8376, 127.8949], "ë¶ë¶€ì‚°": [35.2320, 129.0840], "ë¶ì°½ì›": [35.2700, 128.6800]
}

# ===== ì§€ë„ ìƒì„± =====
m = folium.Map(location=[36.5, 127.8], zoom_start=7)
solar_layer = folium.FeatureGroup(name="â˜€ï¸ ì¼ì‚¬ëŸ‰")
rain_layer = folium.FeatureGroup(name="ğŸŒ§ï¸ ê°•ìˆ˜ëŸ‰")
combo_layer = folium.FeatureGroup(name="â˜€ï¸ğŸŒ§ï¸ ì¼ì‚¬â†‘ + ê°•ìˆ˜â†“")

solar_mean = merged["í•©ê³„ ì¼ì‚¬ëŸ‰(MJ/m2)"].mean()
rain_mean = merged["í‰ê· ê°•ìˆ˜ëŸ‰(mm)"].mean()

# ===== ì§€ë„ì— ì  ì¶”ê°€ =====
for _, row in merged.iterrows():
    name = row["ì§€ì—­"]
    if name not in coords:
        continue

    lat, lon = coords[name]
    solar = row["í•©ê³„ ì¼ì‚¬ëŸ‰(MJ/m2)"]
    rain = row["í‰ê· ê°•ìˆ˜ëŸ‰(mm)"]

    popup_html = f"""
    <div style="font-size:14px; text-align:center;">
        <b>{name}</b><br>
        â˜€ï¸ ì¼ì‚¬ëŸ‰: {solar:.1f} MJ/mÂ²<br>
        ğŸŒ§ï¸ ê°•ìˆ˜ëŸ‰: {rain:.1f} mm
    </div>
    """

    folium.CircleMarker(
        location=[lat, lon],
        radius=max(3, solar * 0.005),
        color="orange",
        fill=True,
        fill_color="orange",
        fill_opacity=0.6,
        popup=popup_html
    ).add_to(solar_layer)

    folium.CircleMarker(
        location=[lat, lon],
        radius=max(3, rain * 0.004),
        color="blue",
        fill=True,
        fill_color="blue",
        fill_opacity=0.5,
        popup=popup_html
    ).add_to(rain_layer)

    if solar > solar_mean and rain < rain_mean:
        folium.CircleMarker(
            location=[lat, lon],
            radius=max(2, rain * 0.003),
            color="green",
            fill=True,
            fill_color="green",
            fill_opacity=0.8,
            popup=f"{name}<br>â˜€ï¸{solar:.1f} MJ/mÂ²<br>ğŸŒ§ï¸{rain:.1f} mm"
        ).add_to(combo_layer)

solar_layer.add_to(m)
rain_layer.add_to(m)
combo_layer.add_to(m)
folium.LayerControl(collapsed=False).add_to(m)

m.save(output_path)
print(f"âœ… ì§€ë„ ìƒì„± ì™„ë£Œ: {output_path}")